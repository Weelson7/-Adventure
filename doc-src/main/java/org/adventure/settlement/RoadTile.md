# RoadTile

**Package:** `org.adventure.settlement`  
**Type:** Entity Class  
**Phase:** 1.10.2  
**Status:** ✅ Complete

## Overview

Represents a road tile connecting structures. Roads are automatically generated between nearby buildings (within 10 tiles) using A* pathfinding. Roads upgrade from DIRT → STONE → PAVED as traffic increases.

## Purpose

- **Structure Connectivity:** Connect buildings via pathfinding
- **Traffic Tracking:** Monitor usage for upgrade progression
- **Movement Speed:** Different road types affect NPC travel speed
- **World Building:** Create believable settlement layouts

## Data Model

```java
public class RoadTile {
    int x, y;               // World coordinates
    RoadType type;          // DIRT, STONE, PAVED
    long createdTick;       // When road was created
    int trafficLevel;       // 0-100, drives upgrades
    boolean isAutoGenerated; // true for automatic roads
    int schemaVersion;      // v1
}
```

## API Reference

### Builder Pattern
```java
RoadTile road = new RoadTile.Builder()
    .x(10)
    .y(20)
    .type(RoadType.DIRT)
    .createdTick(1000)
    .trafficLevel(25)
    .isAutoGenerated(true)
    .build();

// Or use position shorthand
RoadTile road = new RoadTile.Builder()
    .position(10, 20)
    .createdTick(1000)
    .build();  // Defaults to DIRT, traffic=0, autoGen=true
```

### Traffic Management
```java
// Increment traffic (NPCs passing through)
road.incrementTraffic(1);  // +1 for NPC
road.incrementTraffic(5);  // +5 for player

// Traffic caps at 100
int traffic = road.getTrafficLevel();  // 0-100

// Try automatic upgrade
if (road.tryUpgrade()) {
    System.out.println("Road upgraded to " + road.getType());
}
```

### Upgrade Logic
```java
public boolean tryUpgrade() {
    if (type == DIRT && trafficLevel >= 50) {
        type = STONE;
        return true;
    }
    if (type == STONE && trafficLevel >= 80) {
        type = PAVED;
        return true;
    }
    return false;  // No upgrade (already max or insufficient traffic)
}
```

## Upgrade Progression

| Current Type | Traffic Threshold | Next Type | Effect |
|--------------|-------------------|-----------|--------|
| DIRT         | 50+               | STONE     | +50% speed |
| STONE        | 80+               | PAVED     | +100% speed |
| PAVED        | N/A               | (max)     | Full speed |

## Usage Examples

### Automatic Road Generation
```java
// Generate roads between structures
RoadGenerator roadGen = new RoadGenerator(elevationMap);
List<RoadTile> roads = roadGen.generateAutomaticRoads(structures, currentTick);

System.out.println("Generated " + roads.size() + " road tiles");

// Roads are already added to internal network
Collection<RoadTile> allRoads = roadGen.getAllRoads();
```

### Traffic Simulation
```java
// NPC traverses road
RoadTile road = roadNetwork.get("10_20");
road.incrementTraffic(1);

// Check for upgrade every 100 ticks
if (currentTick % 100 == 0) {
    for (RoadTile r : roads) {
        if (r.tryUpgrade()) {
            System.out.println("Road at (" + r.getX() + "," + r.getY() + 
                               ") upgraded to " + r.getType());
        }
    }
}
```

### Movement Speed Calculation
```java
public double getRoadSpeedMultiplier(RoadTile road) {
    switch (road.getType()) {
        case DIRT: return 1.0;   // Base speed
        case STONE: return 1.5;  // +50% faster
        case PAVED: return 2.0;  // +100% faster
        default: return 1.0;
    }
}
```

## Integration

### WorldGen (Phase 11.7)
```java
// After structures and villages are generated
RoadGenerator roadGen = new RoadGenerator(elevationMap);
List<RoadTile> roads = roadGen.generateAutomaticRoads(structures, 0L);
this.roads = roads;
```

### Persistence
```json
{
  "x": 10,
  "y": 20,
  "type": "STONE",
  "createdTick": 1000,
  "trafficLevel": 75,
  "isAutoGenerated": true,
  "schemaVersion": 1
}
```

### Region Simulation
```java
// Track NPC movement on roads
void onNPCMove(NPC npc, int fromX, int fromY, int toX, int toY) {
    String key = toX + "_" + toY;
    RoadTile road = roadNetwork.get(key);
    if (road != null) {
        road.incrementTraffic(1);
        
        // Apply speed bonus
        double speedMultiplier = getRoadSpeedMultiplier(road);
        npc.setMovementSpeed(npc.getBaseSpeed() * speedMultiplier);
    }
}
```

## Testing

**Test Class:** `org.adventure.RoadTileTest`  
**Coverage:** 11 tests, 100% line coverage

### Test Categories
- Builder pattern (defaults, position shorthand)
- Traffic accumulation (increment, cap at 100)
- Upgrade logic (DIRT→STONE, STONE→PAVED, PAVED no upgrade)
- Auto-upgrade flow (sequential progression)

## Design Decisions

### Why Traffic Cap at 100?
- **Prevents Overflow:** Bounded range simplifies calculations
- **Clear Thresholds:** 50 and 80 are easy milestones
- **Future Decay:** Can decrement without going negative (Phase 2.x)

### Why Three Tiers?
- **Clear Progression:** Simple upgrade path for players to understand
- **Mechanical Variety:** Different speeds create tactical choices
- **Visual Feedback:** Easy to distinguish road quality

### Why Auto-Generated Flag?
- **Future Manual Roads:** Players can build custom roads (Phase 2.x)
- **Maintenance:** Manual roads may require upkeep vs automatic
- **Historical Tracking:** Know which roads were planned vs emergent

## Future Enhancements (Phase 2.x)

- **Road Decay:** Unused roads degrade (PAVED → STONE → DIRT)
- **Maintenance Cost:** Clans pay gold to maintain roads
- **Road Blockades:** Bandits can block high-traffic roads
- **Trade Routes:** Major roads become official trade routes
- **Bridges:** Special road tiles over water
- **Weather Effects:** Rain degrades dirt roads faster

## Related Classes

- `RoadType` — DIRT/STONE/PAVED enum
- `RoadGenerator` — A* pathfinding for road creation
- `VillageManager` — Villages connected via roads
- `Structure` — Roads connect structure entrances

## References

- **Design Doc:** `BUILD_PHASE1.10.x.md` → Phase 1.10.2  
- **Tests:** `src/test/java/org/adventure/RoadTileTest.java`

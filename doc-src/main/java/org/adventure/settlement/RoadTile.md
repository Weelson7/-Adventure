# RoadTile

**Package:** `org.adventure.settlement`  
**Type:** Immutable Data Class (with mutable state for type/traffic)  
**Schema Version:** 1

---

## Overview

`RoadTile` represents a single road tile in the game world that connects structures. Roads are automatically generated when buildings are within 10 tiles and can be upgraded from DIRT → STONE → PAVED as traffic increases.

---

## Design Principles

1. **Automatic Generation**: Roads are created automatically by RoadGenerator when structures are nearby
2. **Progressive Upgrades**: Roads improve based on traffic levels (DIRT → STONE at 50 → PAVED at 80)
3. **Permanence**: Roads are permanent once created (no removal in Phase 1.10.2)
4. **Traffic Management**: Track traffic levels (0-100) to determine upgrade eligibility
5. **Builder Pattern**: Flexible construction with sensible defaults

---

## Class Structure

```java
public final class RoadTile {
    // Immutable position
    private final int x;
    private final int y;
    private final long createdTick;
    private final boolean isAutoGenerated;
    private final int schemaVersion;
    
    // Mutable state
    private RoadType type;
    private int trafficLevel;
}
```

---

## Key Methods

### Creation
- **Builder Pattern**: `new RoadTile.Builder()...build()`
  - Fluent API for flexible construction
  - `position(x, y)` convenience method
  - Default values: DIRT type, 0 traffic, auto-generated

### Traffic Management
- **`incrementTraffic(amount)`**: Increase traffic level (capped at 100)
- **`setTrafficLevel(level)`**: Directly set traffic level (0-100)

### Road Upgrades
- **`tryUpgrade()`**: Attempt to upgrade road to next tier
  - DIRT (traffic >= 50) → STONE
  - STONE (traffic >= 80) → PAVED
  - Returns true if upgraded, false otherwise

### Accessors
- **`getX()`**, **`getY()`**: Road tile coordinates
- **`getType()`**: Current road type (DIRT/STONE/PAVED)
- **`getTrafficLevel()`**: Traffic level (0-100)
- **`isAutoGenerated()`**: True if created by RoadGenerator
- **`getCreatedTick()`**: Tick when road was created

---

## Validation Rules

### At Construction
- `type` cannot be null
- `createdTick` cannot be negative
- `trafficLevel` must be between 0 and 100

### At Runtime
- Traffic level updates are clamped to [0, 100] range
- Road type can only be changed via setType() or tryUpgrade()
- Position (x, y) is immutable once set

---

## Upgrade System

### Upgrade Thresholds
- **DIRT → STONE**: Requires traffic level >= 50
- **STONE → PAVED**: Requires traffic level >= 80
- **PAVED**: No further upgrades available

### Upgrade Logic
```java
// Example usage
RoadTile road = new RoadTile.Builder()
    .position(10, 20)
    .type(RoadType.DIRT)
    .trafficLevel(55)
    .build();

boolean upgraded = road.tryUpgrade(); // true, now STONE
```

---

## Equality and Hashing

- **Equality**: Based on position (x, y) only
- **Hash Code**: Based on position (x, y) only
- Roads at the same coordinates are considered equal

---

## Persistence

### JSON Schema (v1)
```json
{
  "x": 10,
  "y": 20,
  "type": "DIRT",
  "createdTick": 1000,
  "trafficLevel": 25,
  "isAutoGenerated": true,
  "schemaVersion": 1
}
```

### Migration Notes
- Schema version 1 (current)
- Use `@JsonCreator` + `@JsonProperty` for Jackson compatibility

---

## Usage Examples

### Create a Basic Road
```java
RoadTile road = new RoadTile.Builder()
    .position(10, 20)
    .type(RoadType.DIRT)
    .createdTick(1000)
    .build();
```

### Increment Traffic and Upgrade
```java
road.incrementTraffic(30); // Traffic: 30
road.incrementTraffic(25); // Traffic: 55
boolean upgraded = road.tryUpgrade(); // true, DIRT → STONE
```

### Traffic Cap Handling
```java
RoadTile road = new RoadTile.Builder()
    .position(10, 20)
    .trafficLevel(95)
    .build();

road.incrementTraffic(10); // Traffic: 100 (capped)
```

---

## Related Classes

- **RoadType**: Enumeration of road tiers (DIRT, STONE, PAVED)
- **RoadGenerator**: Automatic road network generation using A* pathfinding
- **Structure**: Buildings that roads connect
- **EntranceSide**: Structure entrance direction for road connections

---

## Testing

**Test Class**: `RoadTileTest.java`  
**Test Count**: 11+ tests  
**Coverage**: 85%+

### Test Categories
- Builder pattern and defaults (3 tests)
- Traffic management (3 tests)
- Upgrade logic (4 tests)
- Validation (1+ tests)

---

## Design Decisions

1. **Why immutable position?**: Roads represent specific world tiles; changing position would create a different road.

2. **Why traffic cap at 100?**: Simplifies percentage-based calculations and provides clear upgrade thresholds.

3. **Why permanent roads?**: Simplifies game logic in Phase 1.10.2; road removal can be added later if needed.

4. **Why three tiers?**: Provides clear progression (basic → improved → best) without overwhelming complexity.

---

## Future Enhancements (Post-MVP)

1. **Road Maintenance**: Durability decay over time, requiring repairs
2. **Road Removal**: Allow players to remove/rebuild roads
3. **Special Road Types**: Bridges, tunnels, mountain passes
4. **Dynamic Traffic**: Calculate traffic based on actual NPC movement
5. **Road Cost**: Resources required for upgrades

---

## References

- Design: `BUILD_PHASE1.10.x.md` → Phase 1.10.2
- Related: `RoadGenerator.md`, `RoadType.md`, `Village.md`
- Tests: `RoadTileTest.md`
